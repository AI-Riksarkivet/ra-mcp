name: Publish
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish-alpine:
    name: Publish Docker (Alpine) and PyPI
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For uploading SBOM as release asset
    steps:
      - uses: actions/checkout@v5

      - name: Publish Docker Image (Alpine)
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: |
            publish-docker
            --image-repository riksarkivet/ra-mcp
            --tag ${{ github.event.release.tag_name }}
            --base-image python:3.12-alpine
            --tag-suffix -alpine
            --registry docker.io
            --docker-username env:DOCKER_USERNAME
            --docker-password env:DOCKER_PASSWORD
            --source .
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_SECRET }}

      - name: Generate SBOM (Alpine)
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: "export-sbom --base-image python:3.12-alpine --format spdx-json --output-path ./sbom-alpine.spdx.json --source ."
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"

      - name: Upload SBOM as Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ./sbom-alpine.spdx.json

      - name: Publish to PyPI
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: |
            publish-pypi
            --pypi-token env:PYPI_TOKEN
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}

  publish-wolfi:
    name: Publish Docker (Wolfi)
    runs-on: ubuntu-latest
    needs: publish-alpine  # Run after Alpine build
    permissions:
      contents: write  # For uploading SBOM as release asset
    steps:
      - uses: actions/checkout@v5

      - name: Publish Docker Image (Wolfi)
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: |
            publish-docker
            --image-repository riksarkivet/ra-mcp
            --tag ${{ github.event.release.tag_name }}
            --base-image cgr.dev/chainguard/python:latest-dev
            --tag-suffix -wolfi
            --registry docker.io
            --docker-username env:DOCKER_USERNAME
            --docker-password env:DOCKER_PASSWORD
            --source .
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_SECRET }}

      - name: Generate SBOM (Wolfi)
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: "export-sbom --base-image cgr.dev/chainguard/python:latest-dev --format spdx-json --output-path ./sbom-wolfi.spdx.json --source ."
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"

      - name: Upload SBOM as Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ./sbom-wolfi.spdx.json