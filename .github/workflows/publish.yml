name: Publish
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    name: Publish Docker and PyPI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
     
      - name: Publish Docker Image
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: |
            publish
            --image-repository riksarkivet/ra-mcp
            --tag ${{ github.event.release.tag_name }}
            --registry docker.io
            --docker-password ${{ secrets.DOCKERHUB_SECRET }}
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"
      
      - name: Publish to PyPI
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          args: |
            publish-pypi
            --pypi-token ${{ secrets.PYPI_TOKEN }}
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          version: "latest"